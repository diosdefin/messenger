{% extends 'chat/base.html' %}
{% load static %}

{% block meta_title %}–ß–∞—Ç —Å {{ receiver.username }} | ElChat –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'user_list' %}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a></li>
<li class="breadcrumb-item active">–ß–∞—Ç —Å {{ receiver.username }}</li>
{% endblock %}

{% block content %}
<div class="row justify-content-center h-100">
    <div class="col-12 col-md-10 col-lg-8 h-100 d-flex flex-column">
        <div class="chat-container flex-grow-1 d-flex flex-column">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a href="{% url 'user_list' %}" class="btn btn-outline-light btn-sm me-3">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                         style="width: 40px; height: 40px;">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">{{ receiver.username }}</h5>
                        <small class="text-muted">
                            <i class="fas fa-circle text-success me-1"></i>Online
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div id="chat-messages" class="card-body flex-grow-1" style="overflow-y: auto;">
                {% for message in messages %}
                <div class="d-flex mb-3 {% if message.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
                    <div class="message-bubble {% if message.sender == request.user %}message-sent{% else %}message-received{% endif %}">
                        <div class="message-content">
                            {% if message.message_type == 'sticker' %}
                            <span style="font-size: 2rem;">{{ message.content }}</span>
                            {% else %}
                            {{ message.content }}
                            {% endif %}
                        </div>
                        <small class="d-block text-end opacity-75">{{ message.timestamp|time:"H:i" }}</small>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted h-100 d-flex align-items-center justify-content-center">
                    <div>
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div class="card-footer p-0">
                <form method="post" id="message-form" class="p-3">
                    {% csrf_token %}
                    <input type="hidden" name="message_type" id="message-type-input" value="text">
                    
                    <div class="input-group">
                        <!-- –ö–Ω–æ–ø–∫–∞ —Å—Ç–∏–∫–µ—Ä–æ–≤ -->
                        <button type="button" class="btn btn-outline-secondary" onclick="toggleStickers()" title="–°—Ç–∏–∫–µ—Ä—ã">
                            <i class="far fa-smile"></i>
                        </button>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ -->
                        <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('photo-input').click()" title="–§–æ—Ç–æ">
                            <i class="fas fa-camera"></i>
                        </button>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ -->
                        <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('video-input').click()" title="–í–∏–¥–µ–æ">
                            <i class="fas fa-video"></i>
                        </button>
                        
                        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <textarea name="content" id="message-input" class="form-control message-input" 
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1" style="resize: none;"></textarea>
                        
                        <!-- –°–∫—Ä—ã—Ç—ã–µ input –¥–ª—è –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ -->
                        <input type="file" id="photo-input" accept="image/*" class="d-none" onchange="sendPhoto(this.files[0])">
                        <input type="file" id="video-input" accept="video/*" class="d-none" onchange="sendVideo(this.files[0])">
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                        <button type="submit" class="btn btn-primary send-btn" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
                
                <!-- –í—ã–±–æ—Ä —Å—Ç–∏–∫–µ—Ä–æ–≤ -->
                <div id="sticker-picker" class="p-3 border-top" style="display: none; background: var(--card-dark);">
                    <div class="row">
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòÄ')">üòÄ</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòÉ')">üòÉ</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòÑ')">üòÑ</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòÅ')">üòÅ</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòÜ')">üòÜ</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòÖ')">üòÖ</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòÇ')">üòÇ</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('ü§£')">ü§£</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòä')">üòä</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòá')">üòá</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üôÇ')">üôÇ</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üôÉ')">üôÉ</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòâ')">üòâ</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòå')">üòå</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('üòç')">üòç</span></div>
                        <div class="col-2 text-center mb-2"><span class="sticker-btn" onclick="sendSticker('ü•∞')">ü•∞</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* 100% —à–∏—Ä–∏–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 768px) {
        .col-md-10 {
            flex: 0 0 100%;
            max-width: 100%;
        }
        .message-bubble {
            max-width: 85%;
        }
        .chat-container {
            border-radius: 0;
            border: none;
            height: 100vh;
        }
    }
    
    /* –î–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤ */
    @media (min-width: 769px) {
        .col-lg-8 {
            flex: 0 0 95%;
            max-width: 95%;
        }
    }
    
    .sticker-btn {
        font-size: 1.8rem;
        cursor: pointer;
        display: block;
        transition: transform 0.2s;
    }
    
    .sticker-btn:hover {
        transform: scale(1.2);
    }
    
    .send-btn {
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<script>
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        scrollToBottom();
        updateSendButton();
    });
    
    function scrollToBottom() {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function toggleStickers() {
        const picker = document.getElementById('sticker-picker');
        picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞
    function sendSticker(sticker) {
        fetch(`/api/chat/{{ receiver.id }}/send_sticker/`, {
            method: 'POST',
            body: JSON.stringify({sticker: sticker}),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('sticker-picker').style.display = 'none';
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞');
        });
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ
    function sendPhoto(file) {
        if (!file) return;
        
        const formData = new FormData();
        formData.append('media_file', file);
        formData.append('message_type', 'image');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ');
        });
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–¥–µ–æ
    function sendVideo(file) {
        if (!file) return;
        
        const formData = new FormData();
        formData.append('media_file', file);
        formData.append('message_type', 'video');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ');
        });
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
    function updateSendButton() {
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const hasText = messageInput.value.trim().length > 0;
        
        sendButton.disabled = !hasText;
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
    document.getElementById('message-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const sendButton = document.getElementById('send-button');
            if (!sendButton.disabled) {
                document.getElementById('message-form').submit();
            }
        }
    });
    
    // –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
    document.getElementById('message-input').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        updateSendButton();
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    setInterval(updateMessages, 3000);
    
    function updateMessages() {
        fetch(`/api/chat/{{ receiver.id }}/messages/`)
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    const chatMessages = document.getElementById('chat-messages');
                    const currentMessageIds = new Set(
                        Array.from(chatMessages.querySelectorAll('.message-bubble'))
                            .map(el => el.closest('.d-flex').dataset.messageId)
                    );
                    
                    let hasNewMessages = false;
                    
                    data.messages.forEach(message => {
                        if (!currentMessageIds.has(message.id.toString())) {
                            hasNewMessages = true;
                            addMessageToChat(message);
                        }
                    });
                    
                    if (hasNewMessages) {
                        scrollToBottom();
                    }
                }
            })
            .catch(error => console.error('Error updating messages:', error));
    }
    
    function addMessageToChat(message) {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex mb-3 ${message.is_sent ? 'justify-content-end' : 'justify-content-start'}`;
        messageDiv.dataset.messageId = message.id;
        
        let messageContent = '';
        if (message.message_type === 'sticker') {
            messageContent = `
                <div class="message-bubble ${message.is_sent ? 'message-sent' : 'message-received'}">
                    <div class="message-content">
                        <span style="font-size: 2rem;">${message.content}</span>
                    </div>
                    <small class="d-block text-end opacity-75">${message.timestamp}</small>
                </div>
            `;
        } else {
            messageContent = `
                <div class="message-bubble ${message.is_sent ? 'message-sent' : 'message-received'}">
                    <div class="message-content">${message.content}</div>
                    <small class="d-block text-end opacity-75">${message.timestamp}</small>
                </div>
            `;
        }
        
        messageDiv.innerHTML = messageContent;
        chatMessages.appendChild(messageDiv);
        
        // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"
        const emptyMessage = chatMessages.querySelector('.text-center');
        if (emptyMessage) {
            emptyMessage.remove();
        }
    }
</script>
{% endblock %}